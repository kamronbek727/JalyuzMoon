<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JalyuziMoon - Onlayn Do'kon</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0f766e', // Teal 700
                        secondary: '#115e59', // Teal 800
                        accent: '#f59e0b', // Amber 500
                        success: '#10b981', // Emerald 500
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0f766e;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- NAVIGATION -->
    <nav class="bg-white shadow-md fixed w-full z-50 top-0">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center cursor-pointer" onclick="app.navigate('home')">
                    <i class="fa-solid fa-blinds text-primary text-2xl mr-2"></i>
                    <span class="font-bold text-xl text-gray-800">Jalyuzi<span class="text-primary">Moon</span></span>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="app.toggleCart()" class="relative p-2 text-gray-600 hover:text-primary transition">
                        <i class="fa-solid fa-shopping-cart text-xl"></i>
                        <span id="cart-count" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white transform translate-x-1/4 -translate-y-1/4 bg-red-600 rounded-full hidden">0</span>
                    </button>
                    <button id="auth-btn" onclick="app.navigate('login')" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition shadow-sm">
                        <i class="fa-solid fa-user mr-1"></i> Kirish
                    </button>
                    <button id="admin-btn" onclick="app.navigate('admin')" class="hidden px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-black transition shadow-sm">
                        <i class="fa-solid fa-gauge mr-1"></i> Admin
                    </button>
                    <button id="logout-btn" onclick="app.logout()" class="hidden text-red-500 hover:text-red-700 font-medium">
                        Chiqish
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- LOADING OVERLAY -->
    <div id="loading" class="fixed inset-0 bg-white z-[60] flex flex-col justify-center items-center">
        <div class="loader mb-4"></div>
        <p class="text-gray-500">Yuklanmoqda...</p>
    </div>

    <!-- MAIN CONTENT -->
    <div id="app" class="pt-20 pb-10 min-h-screen"></div>

    <!-- FOOTER -->
    <footer class="bg-gray-900 text-white py-8 mt-auto">
        <div class="max-w-7xl mx-auto px-4 grid grid-cols-1 md:grid-cols-3 gap-8 text-center md:text-left">
            <div>
                <h3 class="text-xl font-bold mb-4">JalyuziMoon</h3>
                <p class="text-gray-400 text-sm">Uyingiz va ofisingiz uchun zamonaviy va sifatli jalyuzilar.</p>
            </div>
            <div>
                <h3 class="text-xl font-bold mb-4">Bog'lanish</h3>
                <p id="footer-phone" class="text-gray-400 mb-2">...</p>
                <a id="footer-telegram" href="#" target="_blank" class="text-blue-400 hover:text-blue-300">...</a>
            </div>
            <div>
                <h3 class="text-xl font-bold mb-4">Manzil</h3>
                <p class="text-gray-400">O'zbekiston, Navoiy sh.<br>Barcha viloyatlarga yetkazib beramiz.</p>
            </div>
        </div>
        <div class="text-center mt-8 text-gray-600 text-sm border-t border-gray-800 pt-4">
            &copy; 2026 JalyuziMoon. Barcha huquqlar himoyalangan.
        </div>
    </footer>

    <!-- MODALS -->
    
    <!-- Cart Modal -->
    <div id="cart-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex justify-end">
        <div class="bg-white w-full max-w-md h-full shadow-2xl flex flex-col fade-in">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h2 class="text-lg font-bold text-gray-800"><i class="fa-solid fa-shopping-basket mr-2"></i> Savatcha</h2>
                <button onclick="app.toggleCart()" class="text-gray-500 hover:text-red-500 text-xl">&times;</button>
            </div>
            <div id="cart-items" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
            <div class="p-4 border-t bg-gray-50">
                <div class="flex justify-between text-lg font-bold mb-4">
                    <span>Jami:</span>
                    <span id="cart-total" class="text-primary">0 so'm</span>
                </div>
                <button onclick="app.openCheckout()" class="w-full bg-primary text-white py-3 rounded-lg hover:bg-secondary font-bold shadow-lg transform active:scale-95 transition">
                    Buyurtma berish
                </button>
            </div>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div id="checkout-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden fade-in">
            <div class="bg-primary p-4 flex justify-between items-center">
                <h2 class="text-white font-bold text-xl">Buyurtmani rasmiylashtirish</h2>
                <button onclick="app.closeCheckout()" class="text-white hover:text-gray-200 text-2xl">&times;</button>
            </div>
            <form onsubmit="app.submitOrder(event)" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Ismingiz</label>
                    <input type="text" id="order-name" required class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary focus:outline-none" placeholder="Ism Familiya">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Telefon raqam</label>
                    <input type="tel" id="order-phone" required class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary focus:outline-none" placeholder="+998 90 123 45 67">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Viloyat</label>
                    <select id="order-region" required class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary focus:outline-none bg-white">
                        <option value="">Tanlang...</option>
                        <option value="Toshkent sh.">Toshkent shahri</option>
                        <option value="Toshkent vil.">Toshkent viloyati</option>
                        <option value="Andijon">Andijon</option>
                        <option value="Buxoro">Buxoro</option>
                        <option value="Farg'ona">Farg'ona</option>
                        <option value="Jizzax">Jizzax</option>
                        <option value="Xorazm">Xorazm</option>
                        <option value="Namangan">Namangan</option>
                        <option value="Navoiy">Navoiy</option>
                        <option value="Qashqadaryo">Qashqadaryo</option>
                        <option value="Qoraqalpog'iston">Qoraqalpog'iston</option>
                        <option value="Samarqand">Samarqand</option>
                        <option value="Sirdaryo">Sirdaryo</option>
                        <option value="Surxondaryo">Surxondaryo</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Manzil (To'liq)</label>
                    <textarea id="order-address" required class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary focus:outline-none h-20" placeholder="Tuman, ko'cha, uy raqami..."></textarea>
                </div>
                <button type="submit" class="w-full bg-accent text-white font-bold py-3 rounded-lg hover:bg-yellow-600 transition shadow-md mt-4">
                    Tasdiqlash
                </button>
            </form>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- SUPABASE CONFIG ---
        const SUPABASE_URL = 'https://lrwkisckahttxijkscbg.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_dAQdE-25h3ZEOQrGBowZzA_hmW4FdAG'; 
        
        // --- TELEGRAM CONFIG (UPDATED) ---
        const TG_TOKEN = "8503036122:AAHPS5kQVzu_gjbmye7i8rBOcYVVqstEkh8";
        const ADMIN_CHAT_ID = "656488890";

        let supabaseClient;
        
        const state = {
            categories: [],
            products: [],
            orders: [],
            settings: { phone: "+998 90 123 45 67", telegram_user: "jalyuzi_admin", telegram_chat_id: ADMIN_CHAT_ID },
            cart: JSON.parse(localStorage.getItem('jalyuziCart')) || [],
            user: JSON.parse(localStorage.getItem('jalyuziUser')) || null
        };

        const app = {
            init: async () => {
                try {
                    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    await app.fetchData();
                    app.checkAuth();
                    app.updateCartCount();
                    app.updateContactInfo();
                } catch (e) {
                    console.error("Init Error:", e);
                } finally {
                    document.getElementById('loading').classList.add('hidden');
                    app.navigate('home');
                }
            },

            fetchData: async () => {
                try {
                    const [cats, prods, sets] = await Promise.all([
                        supabaseClient.from('categories').select('*'),
                        supabaseClient.from('products').select('*'),
                        supabaseClient.from('settings').select('*').single()
                    ]);

                    state.categories = cats.data || [];
                    state.products = prods.data || [];
                    
                    if(sets.data) {
                        state.settings = sets.data;
                        // Always ensure the hardcoded ADMIN_CHAT_ID is used if specified in the query
                        state.settings.telegram_chat_id = ADMIN_CHAT_ID;
                    }
                } catch (err) {
                    console.error("Fetch Error:", err);
                }
            },

            checkAuth: () => {
                const navLogin = document.getElementById('auth-btn');
                const navAdmin = document.getElementById('admin-btn');
                const navLogout = document.getElementById('logout-btn');

                if (state.user) {
                    navLogin.classList.add('hidden');
                    navLogout.classList.remove('hidden');
                    if (state.user.role === 'admin') navAdmin.classList.remove('hidden');
                    else navAdmin.classList.add('hidden');
                } else {
                    navLogin.classList.remove('hidden');
                    navAdmin.classList.add('hidden');
                    navLogout.classList.add('hidden');
                }
            },

            updateContactInfo: () => {
                document.getElementById('footer-phone').innerHTML = `<i class="fa-solid fa-phone mr-2"></i>${state.settings.phone || '+998...'}`;
                const tgUser = state.settings.telegram_user ? state.settings.telegram_user.replace('@','') : 'admin';
                document.getElementById('footer-telegram').href = `https://t.me/${tgUser}`;
                document.getElementById('footer-telegram').innerHTML = `<i class="fa-brands fa-telegram mr-2"></i>@${tgUser}`;
            },

            navigate: (page) => {
                const container = document.getElementById('app');
                container.innerHTML = '';
                window.scrollTo(0,0);

                if (page === 'home') app.renderHome(container);
                else if (page === 'login') app.renderLogin(container);
                else if (page === 'admin') {
                    if (state.user && state.user.role === 'admin') app.renderAdmin(container);
                    else app.navigate('login');
                }
            },

            logout: () => {
                state.user = null;
                localStorage.removeItem('jalyuziUser');
                app.checkAuth();
                app.navigate('home');
            },

            renderHome: (container) => {
                const hero = document.createElement('div');
                hero.className = "bg-primary text-white py-16 px-4 text-center mb-8";
                hero.innerHTML = `
                    <h1 class="text-4xl md:text-5xl font-bold mb-4 fade-in">Uyingiz uchun mukammal jalyuzilar</h1>
                    <p class="text-lg md:text-xl text-teal-100 mb-8 max-w-2xl mx-auto">Sifatli, zamonaviy va hamyonbop narxlarda.</p>
                    <button onclick="document.getElementById('products-section').scrollIntoView({behavior: 'smooth'})" class="bg-accent text-white px-8 py-3 rounded-full font-bold shadow-lg hover:bg-yellow-600 transition transform hover:-translate-y-1">
                        Xarid qilish
                    </button>
                `;
                container.appendChild(hero);

                const wrapper = document.createElement('div');
                wrapper.className = "max-w-7xl mx-auto px-4";
                
                const cats = document.createElement('div');
                cats.className = "flex flex-wrap justify-center gap-3 mb-10";
                cats.innerHTML = `<button onclick="app.filterProducts('all')" class="cat-btn px-4 py-2 rounded-full border border-gray-300 hover:bg-primary hover:text-white hover:border-primary transition bg-primary text-white" data-id="all">Barchasi</button>`;
                state.categories.forEach(c => {
                    cats.innerHTML += `<button onclick="app.filterProducts(${c.id})" class="cat-btn px-4 py-2 rounded-full border border-gray-300 text-gray-600 hover:bg-primary hover:text-white hover:border-primary transition" data-id="${c.id}">${c.name}</button>`;
                });
                wrapper.appendChild(cats);

                const grid = document.createElement('div');
                grid.id = 'products-section';
                grid.className = "grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 fade-in";
                app.renderProductCards(grid, state.products);
                wrapper.appendChild(grid);
                container.appendChild(wrapper);
            },

            renderProductCards: (container, products) => {
                container.innerHTML = '';
                if(!products || products.length === 0) {
                    container.innerHTML = `<div class="col-span-full text-center py-10 text-gray-500">Mahsulotlar hali qo'shilmagan.</div>`;
                    return;
                }
                products.forEach(p => {
                    const card = document.createElement('div');
                    card.className = "bg-white rounded-xl shadow-lg hover:shadow-xl transition duration-300 overflow-hidden group flex flex-col";
                    card.innerHTML = `
                        <div class="relative h-48 overflow-hidden">
                            <img src="${p.img}" class="w-full h-full object-cover transform group-hover:scale-110 transition duration-500" onerror="this.src='https://via.placeholder.com/400x300?text=Rasm+yoq'">
                            <div class="absolute inset-0 bg-black bg-opacity-20 opacity-0 group-hover:opacity-100 transition duration-300 flex items-center justify-center">
                                <button onclick="app.addToCart(${p.id})" class="bg-white text-primary px-4 py-2 rounded-full font-bold shadow-lg transform translate-y-4 group-hover:translate-y-0 transition duration-300">
                                    <i class="fa-solid fa-cart-plus"></i> Qo'shish
                                </button>
                            </div>
                        </div>
                        <div class="p-4 flex flex-col flex-1">
                            <h3 class="text-lg font-bold text-gray-800 mb-1 line-clamp-1">${p.name}</h3>
                            <p class="text-sm text-gray-500 mb-3 line-clamp-2 flex-1">${p.description || ''}</p>
                            <div class="flex justify-between items-center mt-auto border-t pt-3">
                                <span class="text-primary font-bold text-lg">${parseInt(p.price || 0).toLocaleString()} so'm</span>
                                <button onclick="app.addToCart(${p.id})" class="text-gray-400 hover:text-primary transition"><i class="fa-solid fa-plus-circle text-2xl"></i></button>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                });
            },

            filterProducts: (catId) => {
                document.querySelectorAll('.cat-btn').forEach(b => {
                    b.classList.remove('bg-primary', 'text-white');
                    b.classList.add('text-gray-600', 'bg-white');
                    if(b.getAttribute('data-id') == catId) {
                        b.classList.add('bg-primary', 'text-white');
                        b.classList.remove('text-gray-600', 'bg-white');
                    }
                });
                const grid = document.getElementById('products-section');
                const filtered = catId === 'all' ? state.products : state.products.filter(p => p.cat_id == catId);
                app.renderProductCards(grid, filtered);
            },

            renderLogin: (container) => {
                container.innerHTML = `
                    <div class="flex justify-center items-center min-h-[60vh] px-4">
                        <div class="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full fade-in">
                            <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">Tizimga kirish</h2>
                            <form onsubmit="app.handleLogin(event)" class="space-y-4">
                                <div><label class="block text-gray-700 text-sm font-bold mb-2">Ism</label><input type="text" id="login-name" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"></div>
                                <div><label class="block text-gray-700 text-sm font-bold mb-2">Telefon raqam</label><input type="text" id="login-phone" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"></div>
                                <button type="submit" class="w-full bg-primary text-white font-bold py-3 rounded-lg hover:bg-secondary transition shadow-lg">Kirish</button>
                            </form>
                        </div>
                    </div>
                `;
            },

            renderAdmin: (container) => {
                container.innerHTML = `
                    <div class="max-w-7xl mx-auto px-4 fade-in">
                        <h1 class="text-3xl font-bold mb-6 text-gray-800"><i class="fa-solid fa-gauge text-primary mr-2"></i>Admin Panel</h1>
                        <div class="flex space-x-2 mb-6 overflow-x-auto pb-2">
                            <button onclick="app.switchAdminTab('products')" id="tab-products" class="admin-tab px-5 py-2 rounded-lg bg-primary text-white font-medium shadow">Mahsulotlar</button>
                            <button onclick="app.switchAdminTab('categories')" id="tab-categories" class="admin-tab px-5 py-2 rounded-lg bg-white text-gray-600 font-medium hover:bg-gray-100 transition">Bo'limlar</button>
                            <button onclick="app.switchAdminTab('orders')" id="tab-orders" class="admin-tab px-5 py-2 rounded-lg bg-white text-gray-600 font-medium hover:bg-gray-100 transition">Buyurtmalar</button>
                            <button onclick="app.switchAdminTab('settings')" id="tab-settings" class="admin-tab px-5 py-2 rounded-lg bg-white text-gray-600 font-medium hover:bg-gray-100 transition">Sozlamalar</button>
                        </div>
                        <div id="admin-content" class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 min-h-[500px] relative"></div>
                    </div>
                `;
                app.renderAdminProducts();
            },

            renderAdminProducts: () => {
                const content = document.getElementById('admin-content');
                let html = `
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold">Mahsulotlar</h2>
                        <button onclick="app.showProductForm()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 shadow flex items-center"><i class="fa-solid fa-plus mr-2"></i> Qo'shish</button>
                    </div>
                    <div class="overflow-x-auto"><table class="w-full text-left border-collapse"><thead><tr class="bg-gray-100 text-gray-600 uppercase text-sm"><th class="py-3 px-4">Rasm</th><th class="py-3 px-4">Nomi</th><th class="py-3 px-4">Narx</th><th class="py-3 px-4 text-center">Amallar</th></tr></thead><tbody>
                `;
                state.products.forEach(p => {
                    html += `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-3 px-4"><img src="${p.img}" class="w-10 h-10 rounded object-cover" onerror="this.src='https://via.placeholder.com/40'"></td>
                            <td class="py-3 px-4 font-medium">${p.name}</td>
                            <td class="py-3 px-4">${parseInt(p.price).toLocaleString()}</td>
                            <td class="py-3 px-4 text-center">
                                <button onclick="app.showProductForm(${p.id})" class="text-blue-600 mr-2 hover:scale-110 transition"><i class="fa-solid fa-pen"></i></button>
                                <button onclick="app.deleteProduct(${p.id})" class="text-red-600 hover:scale-110 transition"><i class="fa-solid fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                });
                html += `</tbody></table></div>`;
                html += app.getProductModalHtml();
                content.innerHTML = html;
            },

            renderAdminCategories: () => {
                const content = document.getElementById('admin-content');
                let html = `
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold">Bo'limlar</h2>
                        <div class="flex gap-2"><input type="text" id="new-cat-name" placeholder="Yangi bo'lim" class="border px-3 py-2 rounded focus:ring-2 focus:ring-primary outline-none"><button onclick="app.addCategory()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Qo'shish</button></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                `;
                state.categories.forEach(c => {
                    html += `<div class="bg-gray-50 p-4 rounded-lg flex justify-between items-center border"><span>${c.name}</span><div class="flex gap-2"><button onclick="app.editCategory(${c.id})" class="text-blue-500"><i class="fa-solid fa-pen"></i></button><button onclick="app.deleteCategory(${c.id})" class="text-red-500"><i class="fa-solid fa-trash"></i></button></div></div>`;
                });
                html += `</div>`;
                content.innerHTML = html;
            },

            renderAdminOrders: async () => {
                const content = document.getElementById('admin-content');
                content.innerHTML = '<div class="loader mx-auto mt-10"></div>';
                
                const { data: orders, error } = await supabaseClient.from('orders').select('*').order('created_at', { ascending: false });
                
                if(error) {
                    content.innerHTML = `<p class="text-red-500">Xatolik: ${error.message}</p>`;
                    return;
                }

                let html = `<h2 class="text-xl font-bold mb-6">Buyurtmalar tarixi</h2>`;
                if(!orders || orders.length === 0) {
                    html += `<p class="text-gray-500">Buyurtmalar yo'q.</p>`;
                } else {
                    html += `<div class="space-y-4">`;
                    orders.forEach(o => {
                        const isCompleted = o.status === 'completed';
                        const statusBadge = isCompleted 
                            ? `<span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-bold border border-green-200"><i class="fa-solid fa-check mr-1"></i> Bajarildi</span>` 
                            : `<span class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-xs font-bold border border-yellow-200"><i class="fa-regular fa-clock mr-1"></i> Yangi</span>`;
                        
                        const completeBtn = !isCompleted 
                            ? `<button onclick="app.completeOrder(${o.id})" class="mt-4 w-full bg-success text-white py-2 rounded-lg font-bold hover:bg-green-600 transition shadow-md"><i class="fa-solid fa-check-double mr-2"></i> Buyurtmani bajardim</button>`
                            : '';

                        html += `
                            <div class="border rounded-lg p-4 hover:shadow-md transition bg-white ${isCompleted ? 'bg-gray-50 opacity-80' : ''}">
                                <div class="flex justify-between items-start mb-2 border-b pb-2">
                                    <div><span class="font-bold text-lg text-primary">#${o.id}</span><span class="text-gray-400 text-xs ml-2 block sm:inline">${new Date(o.created_at).toLocaleString()}</span></div>
                                    ${statusBadge}
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                                    <div>
                                        <p class="font-bold text-lg">${o.client_name}</p>
                                        <p class="text-gray-600 font-medium"><i class="fa-solid fa-phone text-xs mr-1"></i> ${o.client_phone}</p>
                                        <p class="text-gray-500 text-sm mt-1 bg-gray-50 p-2 rounded">${o.region}, ${o.address}</p>
                                    </div>
                                    <div>
                                        <div class="text-sm font-semibold text-gray-700 mb-1">Buyurtma tarkibi:</div>
                                        <ul class="text-sm space-y-1 mb-2 bg-gray-50 p-2 rounded">
                                            ${o.items.map(i => `<li>‚Ä¢ ${i.name} x ${i.qty}</li>`).join('')}
                                        </ul>
                                        <div class="font-bold text-right text-lg border-t pt-2 text-primary">${parseInt(o.total).toLocaleString()} so'm</div>
                                        ${completeBtn}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += `</div>`;
                }
                content.innerHTML = html;
            },

            renderAdminSettings: () => {
                const s = state.settings;
                const content = document.getElementById('admin-content');
                content.innerHTML = `
                    <h2 class="text-xl font-bold mb-6">Tizim sozlamalari</h2>
                    <div class="max-w-md space-y-4">
                        <div><label class="block font-bold mb-1 text-sm">Aloqa raqami</label><input type="text" id="set-phone" value="${s.phone}" class="w-full border p-2 rounded focus:ring-2 focus:ring-primary outline-none"></div>
                        <div><label class="block font-bold mb-1 text-sm">Telegram profil (@-siz)</label><input type="text" id="set-tg" value="${s.telegram_user}" class="w-full border p-2 rounded focus:ring-2 focus:ring-primary outline-none"></div>
                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 shadow-inner">
                            <label class="block font-bold mb-1 text-sm text-blue-800">Telegram Chat ID (Buyurtmalar uchun)</label>
                            <input type="text" id="set-chat-id" value="${s.telegram_chat_id}" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                            <p class="text-[10px] text-blue-600 mt-1 italic">Hozirgi sozlama: ${ADMIN_CHAT_ID}</p>
                        </div>
                        <button onclick="app.saveSettings()" class="w-full bg-primary text-white px-6 py-3 rounded-lg font-bold shadow hover:bg-secondary transition">Saqlash</button>
                    </div>
                `;
            },

            completeOrder: async (id) => {
                if(!confirm("Haqiqatan ham buyurtma bajarildimi?")) return;
                
                const { error } = await supabaseClient.from('orders').update({ status: 'completed' }).eq('id', id);
                if(error) alert("Xatolik: " + error.message);
                else {
                    app.renderAdminOrders();
                }
            },

            addCategory: async () => {
                const name = document.getElementById('new-cat-name').value;
                if(!name) return;
                const { error } = await supabaseClient.from('categories').insert([{ name }]);
                if(error) alert(error.message);
                else { await app.fetchData(); app.renderAdminCategories(); }
            },

            editCategory: async (id) => {
                const cat = state.categories.find(c => c.id == id);
                const newName = prompt("Yangi nom:", cat.name);
                if(newName && newName !== cat.name) {
                    await supabaseClient.from('categories').update({ name: newName }).eq('id', id);
                    await app.fetchData(); app.renderAdminCategories();
                }
            },

            deleteCategory: async (id) => {
                if(!confirm("Bo'limni o'chirsangiz, unga tegishli mahsulotlar ko'rinmay qolishi mumkin. O'chirilsinmi?")) return;
                await supabaseClient.from('categories').delete().eq('id', id);
                await app.fetchData(); app.renderAdminCategories();
            },

            showProductForm: (id = null) => {
                const modal = document.getElementById('product-form-modal');
                const title = document.getElementById('pf-title');
                const catSelect = document.getElementById('pf-cat');
                
                catSelect.innerHTML = `<option value="">Bo'limni tanlang</option>`;
                state.categories.forEach(c => catSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`);

                if(id) {
                    const p = state.products.find(x => x.id === id);
                    document.getElementById('pf-id').value = p.id;
                    document.getElementById('pf-name').value = p.name;
                    document.getElementById('pf-price').value = p.price;
                    document.getElementById('pf-img').value = p.img;
                    document.getElementById('pf-desc').value = p.description || '';
                    catSelect.value = p.cat_id;
                    title.innerText = "Tahrirlash";
                } else {
                    document.getElementById('pf-id').value = '';
                    document.getElementById('pf-name').value = '';
                    document.getElementById('pf-price').value = '';
                    document.getElementById('pf-img').value = '';
                    document.getElementById('pf-desc').value = '';
                    catSelect.value = '';
                    title.innerText = "Yangi mahsulot qo'shish";
                }
                modal.classList.remove('hidden');
            },

            saveProduct: async (e) => {
                e.preventDefault();
                const id = document.getElementById('pf-id').value;
                const data = {
                    name: document.getElementById('pf-name').value,
                    cat_id: parseInt(document.getElementById('pf-cat').value),
                    price: Number(document.getElementById('pf-price').value),
                    img: document.getElementById('pf-img').value,
                    description: document.getElementById('pf-desc').value
                };

                let error;
                if(id) error = (await supabaseClient.from('products').update(data).eq('id', id)).error;
                else error = (await supabaseClient.from('products').insert([data])).error;

                if(error) alert(error.message);
                else {
                    document.getElementById('product-form-modal').classList.add('hidden');
                    await app.fetchData();
                    app.renderAdminProducts();
                }
            },

            deleteProduct: async (id) => {
                if(confirm("Haqiqatan ham ushbu mahsulotni o'chirmoqchimisiz?")) {
                    await supabaseClient.from('products').delete().eq('id', id);
                    await app.fetchData(); app.renderAdminProducts();
                }
            },

            saveSettings: async () => {
                const data = {
                    phone: document.getElementById('set-phone').value,
                    telegram_user: document.getElementById('set-tg').value,
                    telegram_chat_id: document.getElementById('set-chat-id').value
                };
                
                const { data: exist } = await supabaseClient.from('settings').select('id').limit(1);
                
                let error;
                if (exist && exist.length > 0) {
                     error = (await supabaseClient.from('settings').update(data).eq('id', exist[0].id)).error;
                } else {
                     error = (await supabaseClient.from('settings').insert([data])).error;
                }

                if(error) alert(error.message);
                else {
                    state.settings = data;
                    app.updateContactInfo();
                    alert("Sozlamalar saqlandi!");
                }
            },

            handleLogin: (e) => {
                e.preventDefault();
                const name = document.getElementById('login-name').value;
                const phone = document.getElementById('login-phone').value;
                const user = (name.toLowerCase() === 'admin' && phone === '1') 
                    ? { name: 'Admin', phone, role: 'admin' } 
                    : { name, phone, role: 'user' };
                
                state.user = user;
                localStorage.setItem('jalyuziUser', JSON.stringify(user));
                app.navigate(user.role === 'admin' ? 'admin' : 'home');
                app.checkAuth();
            },

            addToCart: (id) => {
                const prod = state.products.find(p => p.id === id);
                if(!prod) return;
                const existing = state.cart.find(i => i.id === id);
                if(existing) existing.qty++;
                else state.cart.push({ ...prod, qty: 1 });
                
                localStorage.setItem('jalyuziCart', JSON.stringify(state.cart));
                app.updateCartCount();
            },

            updateCartCount: () => {
                const count = state.cart.reduce((a, b) => a + b.qty, 0);
                const badge = document.getElementById('cart-count');
                badge.innerText = count;
                badge.classList.toggle('hidden', count === 0);
            },

            toggleCart: () => {
                const modal = document.getElementById('cart-modal');
                if(modal.classList.contains('hidden')) {
                    modal.classList.remove('hidden');
                    const container = document.getElementById('cart-items');
                    container.innerHTML = state.cart.length ? '' : '<div class="text-center text-gray-500 mt-20 flex flex-col items-center"><i class="fa-solid fa-cart-shopping text-4xl mb-2 opacity-20"></i> Savatcha bo\'sh</div>';
                    let total = 0;
                    state.cart.forEach((item, idx) => {
                        total += item.price * item.qty;
                        container.innerHTML += `
                            <div class="flex justify-between items-center border-b pb-3 mb-3 bg-white p-2 rounded-lg shadow-sm">
                                <div class="flex items-center"><img src="${item.img}" class="w-12 h-12 rounded object-cover mr-3 shadow-inner"><div><p class="font-bold text-sm text-gray-800">${item.name}</p><p class="text-xs text-primary font-bold">${parseInt(item.price).toLocaleString()} so'm</p></div></div>
                                <div class="flex items-center gap-2 bg-gray-100 p-1 rounded-lg"><button onclick="app.changeQty(${idx}, -1)" class="w-6 h-6 flex items-center justify-center bg-white rounded shadow-sm font-bold text-gray-600">-</button><span class="font-bold min-w-[20px] text-center">${item.qty}</span><button onclick="app.changeQty(${idx}, 1)" class="w-6 h-6 flex items-center justify-center bg-white rounded shadow-sm font-bold text-gray-600">+</button></div>
                            </div>`;
                    });
                    document.getElementById('cart-total').innerText = total.toLocaleString() + " so'm";
                } else {
                    modal.classList.add('hidden');
                }
            },

            changeQty: (idx, delta) => {
                state.cart[idx].qty += delta;
                if(state.cart[idx].qty <= 0) state.cart.splice(idx, 1);
                localStorage.setItem('jalyuziCart', JSON.stringify(state.cart));
                app.updateCartCount();
                app.toggleCart(); app.toggleCart(); 
            },

            openCheckout: () => {
                if(!state.cart.length) return;
                app.toggleCart();
                document.getElementById('checkout-modal').classList.remove('hidden');
            },

            closeCheckout: () => document.getElementById('checkout-modal').classList.add('hidden'),

            submitOrder: async (e) => {
                e.preventDefault();
                const btn = e.target.querySelector('button[type="submit"]');
                const originalText = btn.innerText;
                btn.disabled = true; btn.innerText = "Yuborilmoqda...";

                const order = {
                    client_name: document.getElementById('order-name').value,
                    client_phone: document.getElementById('order-phone').value,
                    region: document.getElementById('order-region').value,
                    address: document.getElementById('order-address').value,
                    items: state.cart.map(i => ({name: i.name, qty: i.qty, price: i.price})),
                    total: state.cart.reduce((a, b) => a + (b.price * b.qty), 0),
                    status: 'new'
                };

                const { data: newOrder, error } = await supabaseClient.from('orders').insert([order]).select();

                if(error) {
                    alert("Xatolik: " + error.message);
                    btn.disabled = false; btn.innerText = originalText;
                } else {
                    const savedOrder = newOrder[0];
                    // Always use ADMIN_CHAT_ID from config for submission
                    await app.sendToTelegram({...order, id: savedOrder.id});
                    
                    state.cart = [];
                    localStorage.setItem('jalyuziCart', '[]');
                    app.closeCheckout();
                    alert("Buyurtmangiz muvaffaqiyatli qabul qilindi! Tez orada bog'lanamiz.");
                    app.navigate('home');
                    app.updateCartCount();
                }
            },

            sendToTelegram: async (order) => {
                const itemsList = order.items.map(i => `‚ñ´Ô∏è ${i.name} (${i.qty} x ${i.price})`).join('\n');
                const msg = `üì¶ <b>Yangi Buyurtma: #${order.id}</b>\n\nüë§ <b>Mijoz:</b> ${order.client_name}\nüìû <b>Tel:</b> ${order.client_phone}\nüìç <b>Manzil:</b> ${order.region}, ${order.address}\n\nüõí <b>Mahsulotlar:</b>\n${itemsList}\n\nüí∞ <b>Jami: ${parseInt(order.total).toLocaleString()} so'm</b>`;
                try {
                    const response = await fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ chat_id: ADMIN_CHAT_ID, text: msg, parse_mode: 'HTML' })
                    });
                    const result = await response.json();
                    if(!result.ok) {
                        console.error("Telegram API Error:", result.description);
                    }
                } catch (e) { console.error("Network Error:", e); }
            },

            switchAdminTab: (tab) => {
                document.querySelectorAll('.admin-tab').forEach(b => {
                    b.classList.remove('bg-primary', 'text-white', 'shadow');
                    b.classList.add('bg-white', 'text-gray-600');
                });
                document.getElementById(`tab-${tab}`).classList.add('bg-primary', 'text-white', 'shadow');
                if(tab === 'products') app.renderAdminProducts();
                else if(tab === 'categories') app.renderAdminCategories();
                else if(tab === 'orders') app.renderAdminOrders();
                else if(tab === 'settings') app.renderAdminSettings();
            },

            getProductModalHtml: () => `
                <div id="product-form-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl w-full max-w-lg p-6 shadow-2xl fade-in">
                        <div class="flex justify-between items-center mb-6">
                            <h3 id="pf-title" class="text-xl font-bold">Mahsulot</h3>
                            <button onclick="document.getElementById('product-form-modal').classList.add('hidden')" class="text-gray-400 hover:text-red-500 text-2xl">&times;</button>
                        </div>
                        <form onsubmit="app.saveProduct(event)">
                            <input type="hidden" id="pf-id">
                            <div class="grid gap-4 mb-6">
                                <div><label class="block text-xs font-bold mb-1 uppercase text-gray-500">Nomi</label><input type="text" id="pf-name" required class="w-full border p-2 rounded-lg"></div>
                                <div><label class="block text-xs font-bold mb-1 uppercase text-gray-500">Bo'lim</label><select id="pf-cat" required class="w-full border p-2 rounded-lg bg-white"></select></div>
                                <div><label class="block text-xs font-bold mb-1 uppercase text-gray-500">Narxi (so'm)</label><input type="number" id="pf-price" required class="w-full border p-2 rounded-lg"></div>
                                <div><label class="block text-xs font-bold mb-1 uppercase text-gray-500">Rasm manzili (URL)</label><input type="text" id="pf-img" required class="w-full border p-2 rounded-lg"></div>
                                <div><label class="block text-xs font-bold mb-1 uppercase text-gray-500">Tavsif</label><textarea id="pf-desc" class="w-full border p-2 rounded-lg h-20"></textarea></div>
                            </div>
                            <div class="flex justify-end gap-3">
                                <button type="button" onclick="document.getElementById('product-form-modal').classList.add('hidden')" class="px-6 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200">Bekor qilish</button>
                                <button type="submit" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-secondary font-bold shadow-lg">Saqlash</button>
                            </div>
                        </form>
                    </div>
                </div>
            `
        };

        window.addEventListener('load', app.init);
    </script>
</body>
</html>
